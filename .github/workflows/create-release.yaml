name: Create new release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version for the release (e.g., 1.2.3 or 1.2.3-alpha.1)'
        required: true

jobs:
  create_release_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version
        run: |
          echo "${{ github.event.inputs.version }}" | grep -q -P '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*)?(\+[0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*)?$' || exit 1

      - name: Check if tag exists
        run: |
          git fetch --tags
          if git rev-parse "v${{ github.event.inputs.version }}" >/dev/null 2>&1; then
            echo "Tag already exists"
            exit 1
          fi

      - name: Render manifests
        run: IMG=ghcr.io/${{ github.repository }}:${{ inputs.version }} make build-installer

      - name: Update Chart files
        run: |
          # IMPORTANT: Adjust this path to your Chart.yaml file
          CHART_FILE="dist/chart/Chart.yaml"
          VALUES_FILE="dist/chart/values.yaml"
          NEW_VERSION="${{ github.event.inputs.version }}"

          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart file not found at $CHART_FILE"
            exit 1
          fi

          echo "Updating $CHART_FILE to version $NEW_VERSION and appVersion $NEW_VERSION..."
          yq e ".version = \"$NEW_VERSION\"" -i "$CHART_FILE"
          yq e ".appVersion = \"$NEW_VERSION\"" -i "$CHART_FILE"
          echo "Updating $VALUES_FILE to image tag $NEW_VERSION..."
          yq e ".image.tag = \"$NEW_VERSION\"" -i "$VALUES_FILE"

          echo "Successfully updated $CHART_FILE:"
          cat "$CHART_FILE"

      - name: Update helm docs
        uses: losisin/helm-docs-github-action@v1

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Bump version to ${{ github.event.inputs.version }}"
          title: "Bump version to ${{ github.event.inputs.version }}"
          body: |
            This PR bumps the Helm chart version to `${{ github.event.inputs.version }}`.

            Triggered by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: "release/bump-version-${{ github.event.inputs.version }}"
          base: ${{ github.ref_name }}
          add-paths: dist/install.yaml,dist/chart/Chart.yaml,dist/chart/values.yaml,dist/chart/README.md
          delete-branch: true
          labels: |
            automated-pr
